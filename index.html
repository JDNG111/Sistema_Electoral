<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Votaci√≥n - Alcald√≠a de Cali</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
    }
    
    .container-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    
    h1 {
      color: #1e3a8a;
      margin-bottom: 20px;
    }
    
    .status {
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .status.checking {
      background: #fff3cd;
      color: #856404;
    }
    
    .status.online {
      background: #d4edda;
      color: #155724;
    }
    
    .status.offline {
      background: #f8d7da;
      color: #721c24;
    }
    
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    
    .progress-container {
      margin: 20px 0;
    }
    
    .progress {
      height: 30px;
      border-radius: 15px;
    }
    
    .progress-bar {
      font-size: 1rem;
      font-weight: bold;
      transition: width 0.3s ease;
    }
    
    .btn-manual {
      margin-top: 20px;
      padding: 10px 30px;
      border-radius: 50px;
    }
  </style>
</head>
<body>
  <div class="container-box">
    <h1><i class="bi bi-ballot-fill"></i> Sistema de Votaci√≥n</h1>
    <h4 class="text-muted mb-4">Alcald√≠a de Cali</h4>
    
    <div id="status" class="status checking">
      <div class="spinner-border text-warning" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3 mb-2"><strong>Cargando sistema de votaci√≥n...</strong></p>
      <small id="statusText">Iniciando verificaci√≥n inteligente</small>
      
      <div class="progress-container mt-3">
        <div class="progress">
          <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
               role="progressbar" style="width: 0%">0%</div>
        </div>
      </div>
    </div>
    
    <div id="content"></div>
  </div>

  <script>
    // ============================================
    // CONFIGURACI√ìN - ACTUALIZA ESTOS VALORES
    // ============================================
    
    const CONFIG = {
      // URL de tu Apps Script
      appsScriptUrl: 'https://script.google.com/macros/s/AKfycbwRcGiF-Ch0Qmpk6GLY9JxZVvzxMjzAIGG-XFD9DIWhd2_iXN3MiKJxCZKxHPjMsQYw/exec',
      
      // URL de tu Google Form de respaldo
      googleFormUrl: 'https://docs.google.com/forms/d/e/1FAIpQLSdMzilyl8s3Uep61Atp8xEYdky1mFtKqps6E-x-MzyD13CKsg/viewform?usp=dialog',
      
      // Timeout m√°ximo para cargar (8 segundos)
      maxTimeout: 15000,
      
      // Mostrar opci√≥n manual despu√©s de X segundos
      showManualOptionAfter: 20000
    };
    
    // ============================================
    // DETECCI√ìN INTELIGENTE SIN CONSUMIR CUOTA
    // ============================================
    
    let startTime;
    let progressInterval;
    let manualOptionTimeout;
    
    window.onload = function() {
      console.log('üöÄ Iniciando carga del sistema...');
      startTime = Date.now();
      
      // Iniciar barra de progreso
      startProgressBar();
      
      // Intentar cargar Apps Script directamente en un iframe oculto
      cargarAppsScriptDirecto();
      
      // Fallback: Mostrar opci√≥n manual despu√©s de 10 segundos
      manualOptionTimeout = setTimeout(mostrarOpcionManual, CONFIG.showManualOptionAfter);
    };
    
    function startProgressBar() {
      let progress = 0;
      const progressBar = document.getElementById('progressBar');
      const statusText = document.getElementById('statusText');
      
      progressInterval = setInterval(function() {
        progress += 2;
        
        if (progress <= 100) {
          progressBar.style.width = progress + '%';
          progressBar.textContent = progress + '%';
          
          // Actualizar texto seg√∫n progreso
          if (progress < 30) {
            statusText.textContent = 'Conectando con el sistema...';
          } else if (progress < 60) {
            statusText.textContent = 'Verificando disponibilidad...';
          } else if (progress < 90) {
            statusText.textContent = 'Preparando interfaz de votaci√≥n...';
          } else {
            statusText.textContent = 'Casi listo...';
          }
        }
      }, 150);
    }
    
    function stopProgressBar() {
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      if (manualOptionTimeout) {
        clearTimeout(manualOptionTimeout);
      }
    }
    
    function cargarAppsScriptDirecto() {
      // Crear iframe oculto para cargar Apps Script
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = CONFIG.appsScriptUrl;
      
      // Timer para detectar si carga
      const loadTimeout = setTimeout(function() {
        // Si despu√©s de 8 segundos no carg√≥, usar Form
        console.log('‚ö†Ô∏è Timeout: Apps Script no carg√≥ a tiempo');
        detectarFallo();
      }, CONFIG.maxTimeout);
      
      // Si el iframe carga exitosamente
      iframe.onload = function() {
        clearTimeout(loadTimeout);
        const loadTime = Date.now() - startTime;
        console.log('‚úÖ Apps Script carg√≥ en ' + loadTime + 'ms');
        
        // Si carg√≥ r√°pido, est√° funcionando bien
        if (loadTime < CONFIG.maxTimeout) {
          detectarExito();
        } else {
          detectarFallo();
        }
      };
      
      // Si hay error al cargar
      iframe.onerror = function() {
        clearTimeout(loadTimeout);
        console.log('‚ùå Error al cargar Apps Script');
        detectarFallo();
      };
      
      // Agregar iframe al DOM
      document.body.appendChild(iframe);
    }
    
    function detectarExito() {
      stopProgressBar();
      
      document.getElementById('status').className = 'status online';
      document.getElementById('status').innerHTML = 
        '<i class="bi bi-check-circle-fill" style="font-size: 4rem; color: #28a745;"></i>' +
        '<h4 class="mt-3 mb-2">Sistema Disponible</h4>' +
        '<p class="mb-0">Redirigiendo al sistema de votaci√≥n...</p>';
      
      // Redirigir inmediatamente
      setTimeout(function() {
        console.log('‚û°Ô∏è Redirigiendo a Apps Script');
        window.location.replace(CONFIG.appsScriptUrl);
      }, 1000);
    }
    
    function detectarFallo() {
      stopProgressBar();
      
      document.getElementById('status').className = 'status offline';
      document.getElementById('status').innerHTML = 
        '<i class="bi bi-exclamation-triangle-fill" style="font-size: 4rem; color: #dc3545;"></i>' +
        '<h4 class="mt-3 mb-2">Sistema en Mantenimiento</h4>' +
        '<p class="mb-2">Usando sistema de respaldo autom√°tico</p>' +
        '<small class="text-muted">Tu voto se registrar√° correctamente</small>';
      
      document.getElementById('content').innerHTML = 
        '<div class="alert alert-info mt-3">' +
          '<i class="bi bi-info-circle"></i> No te preocupes, el sistema de respaldo es igual de seguro y confiable.' +
        '</div>' +
        '<p class="text-muted">Redirigiendo en <strong><span id="countdown">3</span></strong> segundos...</p>';
      
      // Countdown
      let countdown = 3;
      const interval = setInterval(function() {
        countdown--;
        const countdownEl = document.getElementById('countdown');
        if (countdownEl) {
          countdownEl.textContent = countdown;
        }
        
        if (countdown <= 0) {
          clearInterval(interval);
          redirigirAGoogleForm();
        }
      }, 1000);
    }
    
    function mostrarOpcionManual() {
      // Si despu√©s de 10 segundos no detect√≥ nada, dar opci√≥n manual
      console.log('‚è±Ô∏è Mostrando opci√≥n manual');
      
      stopProgressBar();
      
      document.getElementById('status').className = 'status checking';
      document.getElementById('status').innerHTML = 
        '<i class="bi bi-hourglass-split" style="font-size: 4rem; color: #856404;"></i>' +
        '<h4 class="mt-3 mb-2">La conexi√≥n est√° tomando m√°s tiempo de lo normal</h4>' +
        '<p class="mb-0">Puedes esperar o usar el sistema de respaldo</p>';
      
      document.getElementById('content').innerHTML = 
        '<div class="d-grid gap-2 mt-4">' +
          '<button onclick="forzarAppsScript()" class="btn btn-primary btn-manual">' +
            '<i class="bi bi-arrow-clockwise"></i> Esperar y Continuar' +
          '</button>' +
          '<button onclick="forzarGoogleForm()" class="btn btn-outline-primary btn-manual">' +
            '<i class="bi bi-lightning-fill"></i> Usar Sistema de Respaldo Ahora' +
          '</button>' +
        '</div>' +
        '<p class="text-muted mt-3" style="font-size: 0.9rem;">' +
          '<i class="bi bi-shield-check"></i> Ambas opciones son seguras y registran tu voto correctamente' +
        '</p>';
    }
    
    function forzarAppsScript() {
      console.log('üë§ Usuario eligi√≥ Apps Script manualmente');
      window.location.replace(CONFIG.appsScriptUrl);
    }
    
    function forzarGoogleForm() {
      console.log('üë§ Usuario eligi√≥ Google Form manualmente');
      redirigirAGoogleForm();
    }
    
    function redirigirAGoogleForm() {
      console.log('‚û°Ô∏è Redirigiendo a Google Form');
      window.location.replace(CONFIG.googleFormUrl);
    }
  </script>
</body>
</html>
