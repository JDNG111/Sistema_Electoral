<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Votación - Alcaldía de Cali</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
    }
    
    .container-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    
    .logo {
      max-width: 150px;
      margin-bottom: 20px;
    }
    
    h1 {
      color: #1e3a8a;
      margin-bottom: 20px;
    }
    
    .status {
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .status.checking {
      background: #fff3cd;
      color: #856404;
    }
    
    .status.online {
      background: #d4edda;
      color: #155724;
    }
    
    .status.offline {
      background: #f8d7da;
      color: #721c24;
    }
    
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    
    .btn-primary {
      background: #1e3a8a;
      border: none;
      padding: 15px 40px;
      font-size: 1.1rem;
      border-radius: 50px;
      margin-top: 20px;
    }
    
    .btn-primary:hover {
      background: #3b82f6;
    }
  </style>
</head>
<body>
  <div class="container-box">
    <h1><i class="bi bi-ballot-fill"></i> Sistema de Votación</h1>
    <h4 class="text-muted mb-4">Alcaldía de Cali</h4>
    
    <div id="status" class="status checking">
      <div class="spinner-border text-warning" role="status">
        <span class="visually-hidden">Verificando...</span>
      </div>
      <p class="mt-3 mb-0"><strong>Verificando disponibilidad del sistema...</strong></p>
      <small>Por favor espera unos segundos</small>
    </div>
    
    <div id="content"></div>
  </div>

  <script>
    // ============================================
    // CONFIGURACIÓN - ACTUALIZA ESTOS VALORES
    // ============================================
    
    const CONFIG = {
      // URL de tu Apps Script (la que ya tienes)
      appsScriptUrl: 'https://script.google.com/macros/s/AKfycbzzL6DaM1V7yoV5KxPfiRm3kVN7Nzo4IVblb5XeVHSrHViHQBTgLNhfBP_MgCxNBT6Z/exec',
      
      // URL de tu Google Form de respaldo
      googleFormUrl: 'https://docs.google.com/forms/d/e/1FAIpQLSdMzilyl8s3Uep61Atp8xEYdky1mFtKqps6E-x-MzyD13CKsg/viewform?usp=dialog',
      
      // Timeout en milisegundos (5 segundos)
      timeout: 5000,
      
      // Intentos antes de considerar caído
      maxRetries: 2
    };
    
    // ============================================
    // LÓGICA DE DETECCIÓN AUTOMÁTICA
    // ============================================
    
    let retryCount = 0;
    
    window.onload = function() {
      console.log('Iniciando verificación del sistema...');
      verificarDisponibilidad();
    };
    
    function verificarDisponibilidad() {
      const startTime = Date.now();
      
      // Crear una petición con timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.timeout);
      
      fetch(CONFIG.appsScriptUrl, {
        method: 'GET',
        signal: controller.signal,
        mode: 'no-cors' // Importante para Apps Script
      })
      .then(response => {
        clearTimeout(timeoutId);
        const loadTime = Date.now() - startTime;
        
        console.log('Apps Script respondió en ' + loadTime + 'ms');
        
        // Si responde en menos de 5 segundos, asumimos que funciona
        if (loadTime < CONFIG.timeout) {
          mostrarExito();
          redirigirAAppsScript();
        } else {
          intentarNuevamente();
        }
      })
      .catch(error => {
        clearTimeout(timeoutId);
        console.error('Error al verificar Apps Script:', error);
        
        if (error.name === 'AbortError') {
          console.log('Timeout: Apps Script no respondió a tiempo');
        }
        
        intentarNuevamente();
      });
    }
    
    function intentarNuevamente() {
      retryCount++;
      
      if (retryCount < CONFIG.maxRetries) {
        console.log('Intento ' + (retryCount + 1) + ' de ' + CONFIG.maxRetries);
        document.getElementById('status').innerHTML = 
          '<div class="spinner-border text-warning"></div>' +
          '<p class="mt-3 mb-0"><strong>Verificando nuevamente...</strong></p>' +
          '<small>Intento ' + (retryCount + 1) + ' de ' + CONFIG.maxRetries + '</small>';
        
        setTimeout(verificarDisponibilidad, 2000);
      } else {
        mostrarError();
        redirigirAGoogleForm();
      }
    }
    
    function mostrarExito() {
      document.getElementById('status').className = 'status online';
      document.getElementById('status').innerHTML = 
        '<i class="bi bi-check-circle-fill" style="font-size: 3rem; color: #28a745;"></i>' +
        '<p class="mt-3 mb-0"><strong>Sistema en línea</strong></p>' +
        '<small>Redirigiendo al sistema de votación...</small>';
    }
    
    function mostrarError() {
      document.getElementById('status').className = 'status offline';
      document.getElementById('status').innerHTML = 
        '<i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem; color: #dc3545;"></i>' +
        '<p class="mt-3 mb-0"><strong>Sistema en mantenimiento</strong></p>' +
        '<small>Usando sistema de respaldo...</small>';
      
      document.getElementById('content').innerHTML = 
        '<div class="alert alert-info">' +
          '<i class="bi bi-info-circle"></i> No te preocupes, tu voto se registrará correctamente en el sistema de respaldo.' +
        '</div>' +
        '<p class="text-muted">Redirigiendo en <span id="countdown">3</span> segundos...</p>';
      
      let countdown = 3;
      const interval = setInterval(function() {
        countdown--;
        const countdownEl = document.getElementById('countdown');
        if (countdownEl) {
          countdownEl.textContent = countdown;
        }
        
        if (countdown <= 0) {
          clearInterval(interval);
        }
      }, 1000);
    }
    
    function redirigirAAppsScript() {
      setTimeout(function() {
        console.log('Redirigiendo a Apps Script...');
        window.location.href = CONFIG.appsScriptUrl;
      }, 1500);
    }
    
    function redirigirAGoogleForm() {
      setTimeout(function() {
        console.log('Redirigiendo a Google Form...');
        window.location.href = CONFIG.googleFormUrl;
      }, 3000);
    }
    
    // Función manual para forzar Google Form (opcional)
    function usarFormulario() {
      window.location.href = CONFIG.googleFormUrl;
    }
  </script>
</body>
</html>
